# advanced-model-monitoring.yaml
$schema: https://azuremlschemas.azureedge.net/latest/schedule.schema.json
name: synthetic-yml-monitor
display_name: Diabetes model monitoring
description: Example model monitoring setup with advanced configurations

trigger:
  # perform model monitoring activity daily at 3:15am
  type: recurrence
  frequency: month #can be minute, hour, day, week, month
  interval: 1 # #every day
  schedule: 
    hours: 16 # at 3am
    minutes: 0 # at 15 mins after 3am

create_monitor:
  compute: 
    instance_type: standard_e4s_v3
    runtime_version: 3.2
  monitoring_target:
    ml_task: classification
    model_id: azureml:monitoring-synthetic-pred-maintenance:1
  monitoring_signals:
    advanced_data_drift: # monitoring signal name, any user defined name works
      type: data_drift
      production_data:
        input_data:
          path: azureml:synthetic-urifolder-production@latest
          type: uri_folder
        data_context: model_inputs
        pre_processing_component: preprocess_synthetic_data_spark
        data_window_size: P10000D
      reference_data:
        input_data:
          path: azureml:synthetic-mltable-training@latest # use training data as comparison baseline
          type: mltable
        data_context: training
        target_column_name: failure
      features: 
        top_n_feature_importance: 5 # monitor drift for top 5 features
      alert_enabled: true
      metric_thresholds:
        numerical:
          normalized_wasserstein_distance: 0.1
        categorical:
          jensen_shannon_distance: 0.1

    # advanced_prediction_drift:
    #   type: prediction_drift
    #   production_data:
    #     input_data:
    #       path: azureml:synthetic-urifolder-production@latest
    #       type: uri_folder
    #     data_context: model_inputs
    #     pre_processing_component: preprocess_synthetic_data_spark
    #     data_window_size: P10000D
    #   reference_data:
    #     input_data:
    #       path: azureml:synthetic-mltable-training@latest
    #       type: mltable
    #     data_context: training
    #     target_column_name: failure
    #   features:
    #     top_n_feature_importance: 5
    #   metric_thresholds:
    #     numerical:
    #       normalized_wasserstein_distance: 0.1
    #     categorical:
    #       jensen_shannon_distance: 0.1

    advanced_data_quality:
      type: data_quality
      production_data:
        input_data:
          path: azureml:synthetic-urifolder-production@latest
          type: uri_folder
        data_context: model_inputs
        pre_processing_component: preprocess_synthetic_data_spark
        data_window_size: P10000D
      reference_data:
        input_data:
          path: azureml:synthetic-mltable-training@latest
          type: mltable
        target_column_name: failure
        data_context: training
      alert_enabled: true
      features:
        top_n_feature_importance: 5
      metric_thresholds:
        numerical:
          data_type_error_rate: 0.05
          null_value_rate: 0.05
          out_of_bounds_rate: 0.03
        categorical:
          out_of_bounds_rate: 0.03
          data_type_error_rate: 0.05
          null_value_rate: 0.05

    # feature_attribution_drift_signal:
    #   type: feature_attribution_drift
    #   production_data:
    #     input_data:
    #       path: azureml:synthetic-urifolder-production@latest
    #       type: uri_folder
    #     data_context: model_inputs
    #     pre_processing_component: preprocess_synthetic_data_spark
    #     data_column_names:
    #       correlation_id: Column1
    #     data_window_size: P10000D
    #   reference_data:
    #     input_data:
    #       path: azureml:diabetes-training:1
    #       type: uri_folder
    #     data_context: training
    #     target_column_name: Diabetic
    #   metric_thresholds:
    #     normalized_discounted_cumulative_gain: 0.9
  alert_notification:
    emails:
      - hehein@microsoft.com
      - hendrik.hein@microsoft.com